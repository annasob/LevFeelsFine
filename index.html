<html>
<head>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="http://matrix.senecac.on.ca/~daoberes/json.js"></script>
<!-- 
pastebin: http://pastebin.com/yVySKsZH
-->
<script>
  var DURATION = 2;
  var twitterData = "";
  var locationData = "";
  var searchTerm  = "";
  var loadPage1 = function() {
    document.getElementById("page2").style.display = "none";
    document.getElementById("page1").style.display = "inline";
  };
    
  var loadPage2 = function() {
    document.getElementById("page1").style.display = "none";
    document.getElementById("page2").style.display = "inline";
  };
  
  var run = function () {

      /* Get the screen size */
      screenX = screen.availWidth;
      screenY = screen.availHeight;

      /* Grab the mood to search for */
      mood = twitter.value;
      //alert(mood);
      //mood = "sad";

      /* Get tweets from twitter */
      $.getJSON('http://search.twitter.com/search.json?q=%23' + mood + '&callback=?',
          null, function(data) {

        datalength = data.results.length;
        //datalength = 4;

        /* Store tweets, twitterIds, twitter user pics, and tweet ID's 
          in a JSON object/array */
        jsonTweets = [];    //Declare an array

        /* Iterate through JSON object and push Twitter pictures and tweets
         onto another JSON object */
        for (i = 0; i < datalength; i++) {
          if (data.results[i].text) {
            jsonTweets.push({ "tweetPic" : data.results[i].profile_image_url, 
                              "tweet" : data.results[i].text, 
                              "twitterId" : data.results[i].from_user,
                              "id" : data.results[i].id });
          }
        }
        nextTweetOrNone();
      });
    } //end run

   var nextTweetOrNone = function () {
      if (!jsonTweets.length) {
        getTweets(); //"Activate" if page should be on an infinite loop
        //return; /* "Activate" if only datalength amount tweets will been parsed */
      }
      setTimeout(printTweet, 5000);
    }

  var printTweet = function() {
      /* pop tweets from the jsonTweets object */ 
      var tweetToPrint = jsonTweets.pop();

      /* Declare containers */
      bdy = document.getElementById('normal'); // Gets div
      /* container will contain div for tweetPic and tweet */
      container = document.createElement('span');
      containerWidth = 300;
      containerHeight = 120;

      tweetContainer = document.createElement('span');
      picContainer = document.createElement('span');
      picture = document.createElement('img');
      var picHeight = 48;
      var picWidth = 48;
     
      /* Generate random x and y coordinates */
      var fitsInScreen = false;
      while (!fitsInScreen) {
        x = Math.round(Math.random()*(screenX));
        y = Math.round(Math.random()*(screenY));
        if ((x < screenX - containerWidth) && (y < screenY - containerWidth))
        //if ((x < screenX) && (y < screenY))
          fitsInScreen = true;
      }

      /* Declare colours for each of the hashtags */
      if (mood == "angry") {
        var colours = ["#EE9A49", "#CC3232", "#B22222", "#330000", "#8B7D7B",
                        "#EED5D2", "#FF2400", "#FF6347", "#5E2612", "#E3170D"];
      }
      else if (mood == "sad") {
        var colours = ["#525C65", "#4D4DFF", "#4D6FAC", "#42526C", "#7171C6",
                        "#8968CD", "#104E8B", "#694489", "#0147FA", "#2F2F4F"];
        
      }
      else if (mood == "happy") {
        var colours = ["#698B22", "#FFE600", "#A2C93A", "#FFA824", "#FF8600",
                        "#B13E0F", "#FF3030", "#00B2EE", "#499DF5", "#8968CD"];
      }

      /* The following will randomly determine the colour that the tweet is
        to be printed in */      
      var index = Math.floor(Math.random() * 10);
      
      /* Set attributes of the container */
      $(container).css({'position': 'absolute', 
                      'top' : y + 'px', 
                      'left' : x +'px', 
                      'width' : containerWidth + 'px', 
                      'height' : containerHeight + 'px', 
                      'color' : colours[index],
                      'z-index' : '-1'});

      /* Set attributes of the picture container */
      $(picContainer).css({ 'float' : 'left',
                      'margin-right' : '5px',
                      'width' : picWidth + 'px',
                      'height' : picHeight + 'px'});
      /* Should picContainer have a z-index = 0? */

      picture.src = tweetToPrint.tweetPic;
      picture.style.width = 48;
      picture.style.height = 48;
      picContainer.appendChild(picture);
      container.appendChild(picContainer);

      /* Set attributes of tweetContainer container */
      //$(tweetContainer).css({ });
      
      text = document.createTextNode( "@"+ tweetToPrint.twitterId + ": " + tweetToPrint.tweet);
      tweetContainer.appendChild(text);
      container.appendChild(tweetContainer);

      /* Fade in to screen */
      $(container).fadeIn(3000);
      /* Reduce opacity */
      $(container).fadeTo(1000, 0.30);

      bdy.appendChild(container);

      nextTweetOrNone();
    } //end printTweet

    twitterData = mood;
    loadPage2();
    playVideo();

  // skews an image on four x and y points.
  // make sure the image is using it's natural height and width (don't stretch it) or this function will break!
  CanvasRenderingContext2D.prototype.skew=function(src, co){
    this.save();
    var height=src.height,
        width=src.width,
        t=document.createElement('CANVAS').getContext('2d'),
        leftSpace=Math.min(co[0][0], co[2][0]),
        totalWidth=Math.max(co[1][0], co[3][0])-leftSpace,
        topWidth=co[1][0]-co[0][0],
        botWidth=co[3][0]-co[2][0],
        leftChange=co[2][0]-co[0][0],
        leftTop=co[0][1]-(co[1][1]-co[0][1])*(co[0][0]-leftSpace)/(co[1][0]-co[0][0]),
        rightTop=co[1][1]+(co[1][1]-co[0][1])*(leftSpace+totalWidth-co[1][0])/(co[1][0]-co[0][0]),
        leftBot=co[2][1]-(co[3][1]-co[2][1])*(co[2][0]-leftSpace)/(co[3][0]-co[2][0])-leftTop,
        rightBot=co[3][1]+(co[3][1]-co[2][1])*(leftSpace+totalWidth-co[3][0])/(co[3][0]-co[2][0])-rightTop;
    t.canvas.setAttribute('width', totalWidth);
    t.canvas.setAttribute('height', height);
    if (co[2][0]<co[0][0]) {
      t.translate(co[0][0]-co[2][0], 0);
    }
    for (var i=0; i<height; i++) {
      t.drawImage(src, 0, i, width, 1, leftChange*i/height, i, Math.abs((topWidth*(height-i)+botWidth*i)/height), 1);
    }
    for (var i=0; i<totalWidth; i++) {
      this.drawImage(t.canvas, i, 0, 1, height, leftSpace+i, (leftTop*(totalWidth-i)+rightTop*i)/totalWidth, 1, (leftBot*(totalWidth-i)+rightBot*i)/totalWidth);
    }
    this.restore();
  }
  
  
  var playVideo = function() {
    var interval = 0,
        images = [],
        videoLoaded = false,
        step = 1,
        image = document.getElementById("image"),
        emotion = twitterData,
        video = document.getElementById(emotion),
        middle = document.getElementById("middle"),
        canvasCtx = document.getElementById("canvas").getContext("2d"),
        imageCanvas = document.getElementById("canvas2").getContext("2d");

    var i = {
      i: 0,
      getIndex: function() {
        if (this.i < images.length) {
          return this.i++;
        } else {
          this.i = 1;
          return 0;
        }
      }
  
    };

    $.getJSON("http://api.flickr.com/services/feeds/photos_public.gne?tags=" + emotion + "&lang=en-us&format=json&jsoncallback=?", function(data){
      images = data.items;            
      image.onload = function() {
        if (image.height > image.width) {
          image.src = images[i.getIndex()].media.m;
        }
      };
      document.getElementById("canvas").style.display = "inline";
      window.setInterval((function() {
        if (step === 1) {
          if (!videoLoaded) {
            videoLoaded = true;
            middle.pause();
            middle.currentTime = 0;
            video.play();

            image.src = images[i.getIndex()].media.m;
          }
          if (video.currentTime <= DURATION) {
            canvasCtx.drawImage(video, 0, 0, video.width, video.height);

          } else {
            step ++;
            document.getElementById("canvas2").style.display = "inline";
            imageCanvas.skew(image, [[129,5],[406,39],[96,157],[374,209]]);
          }
        } else if (spep === 2) {
          if (videoLoaded) {
            videoLoaded = false;
            video.pause();
            video.currentTime = 0;
            middle.play();
          }
          if (middle.currentTime <= DURATION) {
            canvasCtx.drawImage(middle, 0, 0, video.width, video.height);
            imageData = canvasCtx.getImageData(0, 0, 480, 270);

          } else {
            step ++;
            run();
            document.getElementById("canvas2").style.display = "none";
          }
        } else {
          clearInterval();
        }
      }), 10);
    });
  };
</script>
</head>

<div style="text-align:center;">
  <div id="page1">
    Twitter:  <input id="twitter" type="text" value="happy" name="twitter" /><br />
    <button type="button" onClick="run();">Click Me!</button><br />
  </div>
  <div id="page2" style="position:relative;">
    <video src="http://scotland.proximity.on.ca/sdowne/lff/sad.ogg" style="display:none;" width="480" height="270" id="sad"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/happy.ogg" style="display:none;" width="480" height="270" id="happy"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/angry.ogg" style="display:none;" width="480" height="270" id="angry"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/neutral.ogg" style="display:none;" width="480" height="270" id="neutral"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/middle.ogg" style="display:none;" width="480" height="270" id="middle"></video>

    <img style="display:none;" id="image" />
    <canvas style="display:none;border-radius:10px;border-style:solid;border-width:15px;" id="canvas" width="480" height="270" ></canvas>
    <canvas style="display:none;position:absolute;left:0px;border-radius:10px;border-style:solid;border-width:15px;" id="canvas2" width="480" height="270" ></canvas>
  </div>
  <div id="normal">

  </div>
</div>
</html>
