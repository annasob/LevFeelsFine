<html>
<head>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script>
  var DURATION = 8;
  var searchTerm = "";
  var twitterData  = "@StephenAtHome"; //"#LevFeels";
  var emotion = "sad";
  var debug;
  var emotionsArray = new Array("happy","angry","sad");
  var iterator = 0;
  var images = [];
  var manager;
  var twitterInterval, videoInterval, videoFunctionInterval;
  
  var mediaManager = function() {
    this.image = document.getElementById("image"),
    this.middle = document.getElementById("middle"),
    this.canvasCtx = document.getElementById("canvas").getContext("2d"),
    this.video = document.getElementById(emotion),
    this.imageCanvas = document.getElementById("canvas2").getContext("2d");
    document.getElementById("canvas").style.display = "inline";
    
  };

  mediaManager.prototype.playMainVideo = function(emotion) {
    if (this.video.paused) {
      // hide the second "middle" part of the video and the flickr image
      document.getElementById("canvas2").style.display = "none";
      document.getElementById("middle").style.display = "none";
      this.video.play();
      // put the video on the canvas
      this.canvasCtx.drawImage(this.video, 0, 0, this.video.width, this.video.height);
      // reset the second "middle" part of the video and pause it
      this.middle.pause();
      this.middle.currentTime = 0;
      // get image ready for second "middle" part of the video       
      this.image.src = images[i.getIndex()].media.m;
      // skew the image
      this.imageCanvas.skew(this.image, [[129,5],[406,39],[96,157],[374,209]]);
    }
  };
  mediaManager.prototype.playMiddleVideo = function(emotion) {
    if (!this.video.paused) {
      // get rid of the first "face" video and get it ready to be played again
      document.getElementById("canvas").style.display = "none";
      this.video.pause();
      this.video.currentTime = 0;
      
      // play the second "middle" part of the video
      this.middle.play();
      // put the "middle" video on the canvas
      this.canvasCtx.drawImage(this.middle, 0, 0, this.video.width, this.video.height);
      
      // make the second "middle" part of the video and the flickr image applear
      document.getElementById("canvas2").style.display = "inline";
      document.getElementById("middle").style.display = "inline";   
    }
  };

  // counter used for flickr get images functionality
  var i = {
      i: 0,
      getIndex: function() {
        if (this.i < images.length) {
          return this.i++;
        } else {
          this.i = 1;
          return 0;
        }
      }
  
  };
	 function init() {
      manager = new mediaManager();
			debug = document.getElementById("mood");
			debug.innerHTML = emotion;
			//twitterInterval = setInterval(getTwitter, 6000); 
      getFlickrImages();
      playVideo();
			//videoFunctionInterval = setInterval(playVideo, 28000); 
      twitterInterval = setInterval(getEmotion, 26000); 
		//	playVideo();
	 }
   function getEmotion(){
      emotion = emotionsArray[iterator];
      debug.innerHTML = emotion;
      iterator ++;
      if (iterator ===3){iterator = 0;}
      //getFlickrImages();
   };
   var getFlickrImages = function getFlickrImager() {
    
    $.getJSON("http://api.flickr.com/services/feeds/photos_public.gne?tags=" + emotion + "&lang=en-us&format=json&jsoncallback=?", function(data){
      images = [];
      images = data.items;            
      image.onload = function() {
        if (image.height > image.width) {
          image.src = images[i.getIndex()].media.m;
        }
      };
   
    });
   
   }
	 var getTwitter = function getTwitter(){
			 // Trim the "@" or "#" from the start of the twitterData 
			searchTerm  = twitterData.replace(/^#/, '').replace(/^@/,'');
			// Get the JSON object for Twitter ID 
			if (twitterData.match(/^@/)) {
				$.getJSON('http://twitter.com/status/user_timeline/'+ searchTerm + '.json?count=5&callback=?', 
						null, function(data) {
						process_data(data);      
				});   
			} //end if (twitterData.match(/^@/)
			// Get the JSON object  for the hashtag
			else if (twitterData.match(/^#/)) {
				$.getJSON('http://search.twitter.com/search.json?q=%23' + searchTerm + '&callback=?', 
						null, function(data) {
					process_data(data);
				});
			}  
		};
			
	 
		/* This function will parse the JSON object for keywords and then return 
			 the mood/emotion about the topic */
		function process_data(tweetData) {
			/* Will contain concatenation of all tweets */
			var tweet = "";
      var i;
			var tweetsRetrieved = tweetData.results || tweetData;
			var tweetsRetrievedLength = tweetsRetrieved.length;
			var maxNumTweets = (tweetsRetrievedLength < maxNumTweets) ? maxNumTweets : 100;
	
			for (i = 0; i < maxNumTweets; i ++) {
				if (tweetsRetrieved[i]) {
					tweet += tweetsRetrieved[i].text;
				}
			}
			/* Declare var happy, sad, and angry and get a count of how 
				often each words pertaining to these emotions are mentioned */
			var happy = 0;
			var sad = 0;
			var angry = 0;
			var tweetArray = tweet.split(' ');
			var tweetArrayLength = tweetArray.length;
			var internetRegex = /http:\/\/*/;   //Regex for the start of a url*/
	
			for (i = 0; i < tweetArrayLength; i++ ) {
				if (tweetArray[i] === "happy" || tweetArray[i] === "excited" || 
						tweetArray[i] === "woot" || tweetArray[i] === ":)" || 
						tweetArray[i] === "wow" || tweetArray[i] === "awesome" ||
						tweetArray[i] === "(:" || tweetArray[i] === "yay" ||
						tweetArray[i] === ":D" || tweetArray[i] === "=)" ||
						tweetArray[i] === "friday") { 
							++happy; 
				} else if (tweetArray[i] === "sad" || tweetArray[i] === ":(" ||
								tweetArray[i] === "bummed" || tweetArray[i] === "disappointed" ||
								tweetArray[i] === "sucks" || tweetArray[i] === ":'(" ||
								tweetArray[i] === "rip"  || tweetArray[i] === "r.i.p." || 
								tweetArray[i] === "died" || tweetArray[i] === "dead") { 
							++sad; 
				} else if (tweetArray[i] === "angry" || tweetArray[i] === "pissed" ||
								tweetArray[i] === "fucked" || tweetArray[i] === "hell" ||
								tweetArray[i] === "stinks" || tweetArray[i] === "upset" ||
								tweetArray[i] === "dammit" ||tweetArray[i] === "crud" ||
								tweetArray[i] === "damn" || tweetArray[i] === ":@") { 
							++angry; 
				} 
			} //end for-loop
	
			if (happy >= sad && happy >= angry) {
				mood = "happy";
			} else if (sad >= happy && sad >= angry) {
				mood = "sad";
			} else if (angry >= sad && angry >= happy) {
				mood = "angry";
			} 
			emotion = mood;
			debug.innerHTML = emotion;
		} //end process_data

  // skews an image on four x and y points.
  // make sure the image is using it's natural height and width (don't stretch it) or this function will break!
  CanvasRenderingContext2D.prototype.skew=function(src, co){
    this.save();
    var height=src.height,
        width=src.width,
        t=document.createElement('CANVAS').getContext('2d'),
        leftSpace=Math.min(co[0][0], co[2][0]),
        totalWidth=Math.max(co[1][0], co[3][0])-leftSpace,
        topWidth=co[1][0]-co[0][0],
        botWidth=co[3][0]-co[2][0],
        leftChange=co[2][0]-co[0][0],
        leftTop=co[0][1]-(co[1][1]-co[0][1])*(co[0][0]-leftSpace)/(co[1][0]-co[0][0]),
        rightTop=co[1][1]+(co[1][1]-co[0][1])*(leftSpace+totalWidth-co[1][0])/(co[1][0]-co[0][0]),
        leftBot=co[2][1]-(co[3][1]-co[2][1])*(co[2][0]-leftSpace)/(co[3][0]-co[2][0])-leftTop,
        rightBot=co[3][1]+(co[3][1]-co[2][1])*(leftSpace+totalWidth-co[3][0])/(co[3][0]-co[2][0])-rightTop;
    t.canvas.setAttribute('width', totalWidth);
    t.canvas.setAttribute('height', height);
    if (co[2][0]<co[0][0]) {
      t.translate(co[0][0]-co[2][0], 0);
    }
    for (var i=0; i<height; i++) {
      t.drawImage(src, 0, i, width, 1, leftChange*i/height, i, Math.abs((topWidth*(height-i)+botWidth*i)/height), 1);
    }
    for (var i=0; i<totalWidth; i++) {
      this.drawImage(t.canvas, i, 0, 1, height, leftSpace+i, (leftTop*(totalWidth-i)+rightTop*i)/totalWidth, 1, (leftBot*(totalWidth-i)+rightBot*i)/totalWidth);
    }
    this.restore();
  }
  var playVideo = function() {
    var interval = 0,
       videoLoaded = false,
        step = true,
        counter = 0,
        
 
      videoInterval = setInterval((function() {
      	if (step) { // video one "face" is playing
          if (manager.video.currentTime <= DURATION) { // draw frame of first "face" video
            manager.playMainVideo();        
          } else { // first "face" video is done, stop first video
            step = false;            
          }
        } else { // video two "middle" is playing
          if (manager.middle.currentTime <= DURATION) { // updated frame for second "middle" video
            manager.playMiddleVideo();
            //imageData = canvasCtx.getImageData(0, 0, 480, 270);
          } else { // second "middle" video is done, stop second video
            step = true;
            
          }
        }
      }), 10);
    

    
  };
  
// Call ready event when DOM is loaded
addEventListener('DOMContentLoaded', function(){ init(); }, false);
</script>
</head>
 <div style="text-align:center;">
 <div id="mood"></div>
  <div id="page1" style="display:none;">
   Twitter:  <input id="twitter" type="text" value="@StephenAtHome" name="twitter" /><br />
    <button type="button" onClick="run();">Click Me!</button><br />
  </div>
  <div id="page2" style="position:relative;display:inline;">
    <video src="http://scotland.proximity.on.ca/sdowne/lff/sad.ogg" style="display:none;" width="480" height="270" id="sad"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/happy.ogg" style="display:none;" width="480" height="270" id="happy"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/angry.ogg" style="display:none;" width="480" height="270" id="angry"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/neutral.ogg" style="display:none;" width="480" height="270" id="neutral"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/middle.ogg" style="display:none;" width="480" height="270" id="middle"></video>

    <img style="display:none;" id="image" />
    <canvas style="display:none;border-radius:10px;border-style:solid;border-width:15px;" id="canvas" width="480" height="270" ></canvas>
    <canvas style="display:none;position:absolute;left:0px;border-radius:10px;border-style:solid;border-width:15px;" id="canvas2" width="480" height="270" ></canvas>
  </div>
</div>
</html>
