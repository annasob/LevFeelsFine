<html>
<head>
<style type="text/css">
.column {
  float:left;
  width: 26%;
  height: 300px;
  padding:10px 10px 10px 10px;
}
#v {
  width: 530px;
}
.top {
  height: 30%;
  padding:10px 10px 10px 10px;
}
</style>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="http://matrix.senecac.on.ca/~daoberes/json.js"></script>

<script>
  var DURATION = 8;
  var DEFAULTEMT = "happy";
  var searchTerm = "";
  var twitterData  = "@StephenAtHome"; //"#LevFeels";
  var emotion = "happy";
  var debug;
  var screenX, screenY;
  var emotionsArray = new Array("angry","sad","happy");
  var iterator = 0;
  var tweetCount = 1;
  var playingVideo = false;
  var twitterInterval,twitterInterval2, videoInterval, videoFunctionInterval;
  var imgUrls = [];/*{
    happyUrls : [],
    sadUrls   : [],
    angryUrls : []  
  };*/
  var images = {
    happyImg : [],
    sadImg   : [],
    angryImg : [],
    happyCounter :0,
    sadCounter   :0,
    angryCounter :0,
  };
  var imgArray = [];
  function fadeIn(audio) {
    // play the song if its not playing
    if (audio.paused) {
      audio.volume = 0.1; 
      audio.play();
    }
    // if the song's volume is below 1 put it up. 1 is max
    if (audio.volume < 1) {
      // Ternary Operator if volume is set to > 1 browser throws error
      audio.volume = ((audio.volume * 2) >= 1) ? 1 : audio.volume * 2;
      setTimeout(function(){fadeIn(audio)},1000);
    }
  };
  function fadeOut(audio) {
    // if the song's volume is above 0.03 lower it
    // using 0.0 will take too long since /2 gets into floating points
    if (audio.volume > 0.03) {
      audio.volume = ((audio.volume /2) <= 0) ? 0 : audio.volume /2;
      setTimeout(function(){fadeOut(audio)},1000);
    } else { audio.currentTime = 0; audio.pause(); }
  };
      
  function init() {
    debug = document.getElementById("mood");
    debug.innerHTML = emotion;
     
    /* Get the screen size */
    screenX = screen.availWidth;
    screenY = screen.availHeight;
  };
    
  var flickrCallback = function(o, emt) {
    for (var i in o.items) {
      // only use landscape images
      //if (o.items.height > o.items.width) {
        imgUrls.push((o.items[i].media.m).replace(/_m\.jpg$/, ".jpg"));
      //}          
    }
    getNextImage(emt);
  };

  // ugly hack made to deal witht the right emotion being passed in to getNextImage
  this.getNextImageangry= function() { getNextImage('angry'); };
  this.getNextImagesad = function() { getNextImage('sad'); };
  this.getNextImagehappy = function() { getNextImage('happy'); };
  
  var getNextImage = function(emt) {
    if (getNextImage.idx++ == imgUrls.length) {
      return;
    }

    var nextUrl = imgUrls[getNextImage.idx],
        cacheImageFunc = (function(emot) {
        var emt = emot;
        return function(url, img) {
        if( url == "http://farm5.static.flickr.com/4154/5027601109_1e65700c4d.jpg" || url == "http://farm5.static.flickr.com/4087/5027600333_116331c8f2.jpg" ||
          url == "http://farm5.static.flickr.com/4128/5027596623_6372cd3f5c.jpg" ) { alert (emt); }
          imgArray.push({image: img, type: emt});
          /*if( !playingVideo && DEFAULTEMT === emt){
            playingVideo = true;
            playVideo();
          }*/
        };
      })(emt);
    setTimeout(function() { loadImage(nextUrl, cacheImageFunc, this['getNextImage' + emt]); }, 30);
  }
  getNextImage.idx = 0;

  var loadImage = function(url, aCacheImage, aCallback) {
    var img = document.createElement('img');

    img.onload = (function(aCacheImage, aCallback) {
      var cacheImage = aCacheImage,
          callback = aCallback;
      return function() {
        cacheImage(this.src, this);
        callback();
      };
    })(aCacheImage, aCallback);
    img.src = url;
  };
            
  function getEmotion(){
    emotion = emotionsArray[iterator];
    debug.innerHTML = emotion;
    iterator ++;
    if (iterator ===3){iterator = 0;}
  };
  var getTwitter = function getTwitter(){
    /* Get tweets from twitter */
    $.getJSON('http://search.twitter.com/search.json?q=%23' + emotion + '&callback=?',
        null, function(data) {

      datalength = data.results.length;
      //datalength = 4;

      /* Store tweets, twitterIds, twitter user pics, and tweet ID's 
        in a JSON object/array */
      jsonTweets = [];    //Declare an array

      /* Iterate through JSON object and push Twitter pictures and tweets
       onto another JSON object */
      for (i = 0; i < datalength; i++) {
        if (data.results[i].text) {
          jsonTweets.push({ "tweetPic" : data.results[i].profile_image_url, 
                            "tweet" : data.results[i].text, 
                            "twitterId" : data.results[i].from_user,
                            "id" : data.results[i].id });
        }
      }
      nextTweetOrNone();
    });    
  };
  var nextTweetOrNone = function () {
    if (!jsonTweets.length) {
      // get new tweets... shouldnt be used because getTwitter() is on interval
      getTwitter(); //"Activate" if page should be on an infinite loop
      //return; /* "Activate" if only datalength amount tweets will been parsed */
    }
    setTimeout(printTweet, 5000);
  };

  var printTweet = function() {
    /* pop tweets from the jsonTweets object */ 
    var tweetToPrint = jsonTweets.pop();

    /* Declare containers */
    bdy = document.getElementById('tweet' + tweetCount); // Gets div
    tweetCount ++;
    if (tweetCount >4) { tweetCount = 1; }
    /* container will contain div for tweetPic and tweet */
    container = document.createElement('span');
    containerWidth = 300;
    containerHeight = 120;

    tweetContainer = document.createElement('span');
    picContainer = document.createElement('span');
    picture = document.createElement('img');
    var picHeight = 48;
    var picWidth = 48;
   
    /* Generate random x and y coordinates */
    var fitsInScreen = false;
    while (!fitsInScreen) {
      x = Math.round(Math.random()*(screenX));
      y = Math.round(Math.random()*(screenY));
      if ((x < screenX - containerWidth) && (y < screenY - containerWidth))
      //if ((x < screenX) && (y < screenY))
        fitsInScreen = true;
    }

    /* Declare colours for each of the hashtags */
    if (emotion == "angry") {
      var colours = ["#EE9A49", "#CC3232", "#B22222", "#330000", "#8B7D7B",
                      "#EED5D2", "#FF2400", "#FF6347", "#5E2612", "#E3170D"];
    }
    else if (emotion == "sad") {
      var colours = ["#525C65", "#4D4DFF", "#4D6FAC", "#42526C", "#7171C6",
                      "#8968CD", "#104E8B", "#694489", "#0147FA", "#2F2F4F"];
      
    }
    else if (emotion == "happy") {
      var colours = ["#698B22", "#FFE600", "#A2C93A", "#FFA824", "#FF8600",
                      "#B13E0F", "#FF3030", "#00B2EE", "#499DF5", "#8968CD"];
    }

    /* The following will randomly determine the colour that the tweet is
      to be printed in */      
    var index = Math.floor(Math.random() * 10);
    
    /* Set attributes of the container */
    $(container).css({'position': 'absolute', 
                    'top' : y + 'px', 
                    'left' : x +'px', 
                    'width' : containerWidth + 'px', 
                    'height' : containerHeight + 'px', 
                    'colour' : colours[index],
                    'z-index' : '-1'});

    /* Set attributes of the picture container */
    $(picContainer).css({ 'float' : 'left',
                    'margin-right' : '5px',
                    'width' : picWidth + 'px',
                    'height' : picHeight + 'px'});
    /* Should picContainer have a z-index = 0? */

    picture.src = tweetToPrint.tweetPic;
    picture.style.width = 48;
    picture.style.height = 48;
    picContainer.appendChild(picture);
    container.appendChild(picContainer);

    /* Set attributes of tweetContainer container */
    //$(tweetContainer).css({ });
    
    text = document.createTextNode( "@"+ tweetToPrint.twitterId + ": " + tweetToPrint.tweet);
    tweetContainer.appendChild(text);
    container.appendChild(tweetContainer);

    /* Fade in to screen */
    $(container).fadeIn(3000);
    /* Reduce opacity */
    $(container).fadeTo(1000, 0.30);

    bdy.appendChild(container);

    nextTweetOrNone();
  }; //end printTweet

  // skews an image on four x and y points.
  // make sure the image is using it's natural height and width (don't stretch it) or this function will break!
  CanvasRenderingContext2D.prototype.skew=function(src, co){
    this.save();
    var height=src.height,
        width=src.width,
        t=document.createElement('CANVAS').getContext('2d'),
        leftSpace=Math.min(co[0][0], co[2][0]),
        totalWidth=Math.max(co[1][0], co[3][0])-leftSpace,
        topWidth=co[1][0]-co[0][0],
        botWidth=co[3][0]-co[2][0],
        leftChange=co[2][0]-co[0][0],
        leftTop=co[0][1]-(co[1][1]-co[0][1])*(co[0][0]-leftSpace)/(co[1][0]-co[0][0]),
        rightTop=co[1][1]+(co[1][1]-co[0][1])*(leftSpace+totalWidth-co[1][0])/(co[1][0]-co[0][0]),
        leftBot=co[2][1]-(co[3][1]-co[2][1])*(co[2][0]-leftSpace)/(co[3][0]-co[2][0])-leftTop,
        rightBot=co[3][1]+(co[3][1]-co[2][1])*(leftSpace+totalWidth-co[3][0])/(co[3][0]-co[2][0])-rightTop;
    t.canvas.setAttribute('width', totalWidth);
    t.canvas.setAttribute('height', height);
    if (co[2][0]<co[0][0]) {
      t.translate(co[0][0]-co[2][0], 0);
    }
    for (var i=0; i<height; i++) {
      t.drawImage(src, 0, i, width, 1, leftChange*i/height, i, Math.abs((topWidth*(height-i)+botWidth*i)/height), 1);
    }
    for (var i=0; i<totalWidth; i++) {
      this.drawImage(t.canvas, i, 0, 1, height, leftSpace+i, (leftTop*(totalWidth-i)+rightTop*i)/totalWidth, 1, (leftBot*(totalWidth-i)+rightBot*i)/totalWidth);
    }
    this.restore();
  };

  var playVideo = function() {
    var interval = 0,
       videoLoaded = false,
        step = true,
        oldEmotion = "",
        image = document.getElementById("image"),
        video = document.getElementById(emotion),
        middle = document.getElementById("middle"),
        canvasCtx = document.getElementById("canvas").getContext("2d"),
        imageCanvas = document.getElementById("canvas2").getContext("2d");
        document.getElementById("canvas").style.display = "inline";
      videoInterval = setInterval((function() {
      	if (step) { // video one "face" is playing
          if (!videoLoaded) { // loads second "middle" video if it's not loaded
            videoLoaded = true;
            middle.pause();
            middle.currentTime = 0;
            video.play();
            //counter = images[emotion+"Counter"];
            for (counter = 0; counter < imgArray.length; counter ++) { 
              if ( imgArray[counter]["type"] === emotion ) {
              
                image.src = imgArray[counter]["image"].src;
                imgArray.splice(counter,1);
                counter = imgArray.length;
              }
            }
          }
          if (video.currentTime <= DURATION) { // draw frame of first "face" video
            canvasCtx.drawImage(video, 0, 0, video.width, video.height);
            //mozRequestAnimationFrame instead of drawimage
          } else { // first "face" video is done, stop first video
            step = false;
            document.getElementById("canvas2").style.display = "inline";
            imageCanvas.skew(image, [[129,5],[406,39],[96,157],[374,209]]);
          }
        } else { // video two "middle" is playing
          if (videoLoaded) { // loads first "face" video if it's not loaded
          	videoLoaded = false;
            video.pause();
            video.currentTime = 0;
            oldEmotion = video.id;
            // update video if emotion changed
            video = document.getElementById(emotion);
            video.pause();
            video.currentTime = 0;
            middle.play();
            if (oldEmotion !== emotion) {
              fadeOut(document.getElementById(oldEmotion+"Song"));
              fadeIn(document.getElementById(emotion+"Song"));
            }
          }
          if (middle.currentTime <= DURATION) { // updated frame for second "middle" video
            canvasCtx.drawImage(middle, 0, 0, video.width, video.height);
            //imageData = canvasCtx.getImageData(0, 0, 480, 270);

          } else { // second "middle" video is done, stop second video
            step = true;
            document.getElementById("canvas2").style.display = "none";
          }
        }
      }), 10);  
  };
  
// Call ready event when DOM is loaded
addEventListener('DOMContentLoaded', function(){ 
   
  setTimeout(function() {
    $.getJSON('http://api.flickr.com/services/feeds/photos_public.gne?tags=happy&lang=en-us&format=json&jsoncallback=?',null, function(data){ flickrCallback(data, "happy");});
    $.getJSON('http://api.flickr.com/services/feeds/photos_public.gne?tags=sad&lang=en-us&format=json&jsoncallback=?',null, function(data){ flickrCallback(data, "sad");});
    $.getJSON('http://api.flickr.com/services/feeds/photos_public.gne?tags=angry&lang=en-us&format=json&jsoncallback=?',null, function(data){ flickrCallback(data, "angry");});
  }, 1000);
  init();
 twitterInterval2 = setInterval(getEmotion, (DURATION *3)*1000);
 twitterInterval = setInterval(getTwitter, (DURATION *3)*1000);
 setTimeout(playVideo, 10000);
 setTimeout(function() { document.getElementById("happySong").play()}, 10000);
}, false);
</script>
</head>
<div class="top" id="tweet1">&nbsp;</div>
<div id="centre">
  <div class="column" id="tweet2">&nbsp;</div>
  <div class="column" id="v">
    <div style="text-align:center;padding:10px 10px 10px 10px;">
      <div id="mood" style="text-align:center;"></div>

      <div style="position:relative;display:inline;">
        <video src="http://scotland.proximity.on.ca/sdowne/lff/sad.ogg" style="display:none;" width="480" height="270" id="sad"></video>
        <video src="http://scotland.proximity.on.ca/sdowne/lff/happy.ogg" style="display:none;" width="480" height="270" id="happy"></video>
        <video src="http://scotland.proximity.on.ca/sdowne/lff/angry.ogg" style="display:none;" width="480" height="270" id="angry"></video>
        <video src="http://scotland.proximity.on.ca/sdowne/lff/neutral.ogg" style="display:none;" width="480" height="270" id="neutral"></video>
        <video src="http://scotland.proximity.on.ca/sdowne/lff/middle.ogg" style="display:none;" width="480" height="270" id="middle"></video>

        <img style="display:none;" id="image" />
        <canvas style="display:none;border-radius:10px;border-style:solid;border-width:15px;" id="canvas" width="480" height="270" ></canvas>
        <canvas style="display:none;position:absolute;left:0px;border-radius:10px;border-style:solid;border-width:15px;" id="canvas2" width="480" height="270" ></canvas>
        <audio style="display:none;" src="http://scotland.proximity.on.ca/sdowne/LevFeelsFine/music/sad.ogg" id="sadSong" controls="none"></audio>
        <audio style="display:none;" src="http://scotland.proximity.on.ca/sdowne/LevFeelsFine/music/happy.ogg" id="happySong" controls="none"></audio>
        <audio style="display:none;" src="angry.ogg" id="angrySong" controls="none"></audio>
      </div>
    </div>
  </div>
  <div class="column" id="tweet3">&nbsp;</div>
  <div style="clear:both"></div>
</div>
<div class="top" id="tweet4">&nbsp;</div>

</html>
