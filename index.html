<html>
<head>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script>
  var DURATION = 2;
  var twitterData = "";
  var locationData = "";
  var  searchTerm  = "";
  var loadPage1 = function() {
    document.getElementById("page2").style.display = "none";
    document.getElementById("page1").style.display = "inline";
  };
    
  var loadPage2 = function() {
    document.getElementById("page1").style.display = "none";
    document.getElementById("page2").style.display = "inline";
  };
  
  var run = function() {
    // Get the hashtag or twitter ID entered in the textbox 
    twitterData = document.getElementById("twitter").value;
    // Trim the "@" or "#" from the start of the twitterData 
    searchTerm  = twitterData.replace(/^#/, '').replace(/^@/,'');
    // Get the JSON object for Twitter ID 
    if (twitterData.match(/^@/)) {
      $.getJSON('http://twitter.com/status/user_timeline/'+ searchTerm + '.json?count=5&callback=?', 
          null, function(data) {

        process_data(data);      
      });   
    } //end if (twitterData.match(/^@/)
    // Get the JSON object  for the hashtag
    else if (twitterData.match(/^#/)) {
      $.getJSON('http://search.twitter.com/search.json?q=%23' + searchTerm + '&callback=?', 
          null, function(data) {

        process_data(data);
      });
    }
    // get browser geolocation if the checkmark is checked and data from location input otherwise
    if (document.getElementById("checkmark").checked === true) {
      // Request a position. We accept positions whose age is not
      // greater than 10 minutes. If the User Agent does not have a
      // fresh enough cached position object, it will automatically
      // acquire a new one.
      navigator.geolocation.getCurrentPosition(successCallback,
                                               errorCallback,
                                               {maximumAge:600000});
    } else {
      // include the Google API script   
      locationData = document.getElementById("location").value;
      get_position(locationData);
    }
  };
  
  //navigator.geolocation.getCurrentPosition success function 
  //get the geolocation city and region
  function successCallback(position) {
    get_position(position.address.city+","+position.address.region);
  };
  
  //navigator.geolocation.getCurrentPosition error function 
  function errorCallback(error) {
    switch(error.code)  
    {  
      case error.PERMISSION_DENIED: alert("user did not share geolocation data");  
      break;  

      case error.POSITION_UNAVAILABLE: alert("could not detect current position");  
      break;  

      case error.TIMEOUT: alert("retrieving position timedout");  
      break;  

      default: alert("unknown error");  
      break;  
    }  
  };
  
  //fetch google API weather that has been converted to JSON using yahoo pipes
  function get_position(location) {
      var e=document.createElement('script');
      e.setAttribute('src','http://pipes.yahoo.com/pipes/pipe.run?_id=0074f9866dcef3d752203f8cf708f491&_render=json&_callback=getWeather&weather='+ location);
      document.body.appendChild(e);  
  };
  
  function getWeather(o) {
    var background;
    //make sure there was no parse error
    var datetime = o.value.items[0].weather.forecast_information.current_date_time.data;
    var time =  /(\d\d)/.exec(/( \d\d:)/.exec(datetime));
    if (o.value.items[0].weather.current_conditions.condition.data){
      switch (o.value.items[0].weather.current_conditions.condition.data){
        case "Partly Sunny": 
        case "Sunny": 
        case "Mostly Sunny":
        case "Clear":
          if( time[0] >= "20") {
            background = "images/clearNight.jpg"
            document.body.style.backgroundColor = "rbg(10, 10, 133)";
          } else {
            background = "images/clearDay.jpg"
            document.body.style.backgroundColor = "blue";
          }     
          break;
        case "Scattered Thunderstorms":
        case "Storm":
        case "Thunderstorm":
          if( time[0] >= "20") {
            background = "images/thunderstormNight.jpg"
            document.body.style.backgroundColor = "black";
          } else {
            background = "images/thunderstormDay.jpg"
            document.body.style.backgroundColor = "black";
          }     
          break;
        case "Showers":
        case "Scattered Showers":
        case "Rain And Snow":
        case "Chance Of Rain":
        case "Rain":
        case "Mist":
        case "Drizzle":
        case "Light Rain":
          break;
        case "Overcast":
        case "Partly Cloudy": 
        case "Dust":
        case "Smoke":
        case "Haze":
          if( time[0] >= "20") {
            background = "images/claudyNight.jpg"
            document.body.style.backgroundColor = "rbg(10, 10, 133)";
          } else {
            background = "images/claudyDay.jpg"
            document.body.style.backgroundColor = "blue";
          }     
          break;
        case "Light Snow":
        case "Freezing Drizzle":
        case "Chance Of Snow":
        case "Sleet":
        case "Icy":
          break;  
        case "Fog":
          if( time[0] >= "20") {
            background = "images/fogNight.jpg"
            document.body.style.backgroundColor = "rgb(32,32,32)";
          } else {
            background = "images/fogDay.jpg"
            document.body.style.backgroundColor = "rgb(208,208,208)";
          } 
          break;  
        case "Snow":
        case "Flurries":
          break;
        case "Mostly Cloudy":
        case "Chance Of Storm":
        case "Cloudy":
        case "Chance Of TStorm":
          if( time[0] >= "20") {
            background = "images/veryClaudyNight.jpg"
            document.body.style.backgroundColor = "rgb(32,32,32)";
          } else {
            background = "images/veryClaudyDay.jpg"
            document.body.style.backgroundColor = "rgb(208,208,208)";
          } 
          break;
      }
      document.body.background = background;
      document.body.style.backgroundRepeat = "no-repeat";
      document.body.style.backgroundPosition = "top center";
    }
	};
  /* This function will parse the JSON object for keywords and then return 
     the mood/emotion about the topic */
  function process_data(tweetData) {

    /* Will contain concatenation of all tweets */
    var tweet = "";
    var tweetsRetrieved = tweetData.results || tweetData;
    var tweetsRetrievedLength = tweetsRetrieved.length;
    var maxNumTweets = (tweetsRetrievedLength < maxNumTweets) ? maxNumTweets : 100;

    for (i = 0; i < maxNumTweets; i ++) {
      if (tweetsRetrieved[i]) {
        tweet += tweetsRetrieved[i].text;
      }
    }

    /* Declare var happy, sad, angry, and neutral, and get a count of how 
      often each words pertaining to these emotions are mentioned */
    var happy = 0;
    var sad = 0;
    var angry = 0;
    var neutral = 0;        //For posts that are objective (ie. to links)
    var mood = "neutral";   //Default mood is neutral
    var tweetArray = tweet.split(' ');
    var tweetArrayLength = tweetArray.length;
    var internetRegex = /http:\/\/*/;   //Regex for the start of a url

    for (i = 0; i < tweetArrayLength; i++ ) {
      if (tweetArray[i] === "happy" || tweetArray[i] === "excited" || 
          tweetArray[i] === "woot" || tweetArray[i] === ":)" || 
          tweetArray[i] === "wow" || tweetArray[i] === "awesome" ||
          tweetArray[i] === "(:" || tweetArray[i] === "yay" ||
          tweetArray[i] === ":D" || tweetArray[i] === "=)" ||
          tweetArray[i] === "friday") { 
            ++happy; 
      } else if (tweetArray[i] === "sad" || tweetArray[i] === ":(" ||
              tweetArray[i] === "bummed" || tweetArray[i] === "disappointed" ||
              tweetArray[i] === "sucks" || tweetArray[i] === ":'(" ||
              tweetArray[i] === "rip"  || tweetArray[i] === "r.i.p." || 
              tweetArray[i] === "died" || tweetArray[i] === "dead") { 
            ++sad; 
      } else if (tweetArray[i] === "angry" || tweetArray[i] === "pissed" ||
              tweetArray[i] === "fucked" || tweetArray[i] === "hell" ||
              tweetArray[i] === "stinks" || tweetArray[i] === "upset" ||
              tweetArray[i] === "dammit" ||tweetArray[i] === "crud" ||
              tweetArray[i] === "damn" || tweetArray[i] === ":@") { 
            ++angry; 
      } else if (tweetArray[i].match(internetRegex)) {
                ++neutral;
      }
    } //end for-loop

    if (happy >= sad && happy >= angry && happy >= neutral) {
      mood = "happy";
    } else if (sad >= happy && sad >= angry && sad >= neutral) {
      mood = "sad";
    } else if (angry >= sad && angry >= happy && angry >= neutral) {
      mood = "angry";
    } else if (neutral > angry && neutral > happy && neutral > sad) {
      mood = "neutral";
    }
    alert(mood);
    twitterData = mood;
    loadPage2();
    playVideo();
  } //end process_data

  // skews an image on four x and y points.
  // make sure the image is using it's natural height and width (don't stretch it) or this function will break!
  CanvasRenderingContext2D.prototype.skew=function(src, co){
    this.save();
    var height=src.height,
        width=src.width,
        t=document.createElement('CANVAS').getContext('2d'),
        leftSpace=Math.min(co[0][0], co[2][0]),
        totalWidth=Math.max(co[1][0], co[3][0])-leftSpace,
        topWidth=co[1][0]-co[0][0],
        botWidth=co[3][0]-co[2][0],
        leftChange=co[2][0]-co[0][0],
        leftTop=co[0][1]-(co[1][1]-co[0][1])*(co[0][0]-leftSpace)/(co[1][0]-co[0][0]),
        rightTop=co[1][1]+(co[1][1]-co[0][1])*(leftSpace+totalWidth-co[1][0])/(co[1][0]-co[0][0]),
        leftBot=co[2][1]-(co[3][1]-co[2][1])*(co[2][0]-leftSpace)/(co[3][0]-co[2][0])-leftTop,
        rightBot=co[3][1]+(co[3][1]-co[2][1])*(leftSpace+totalWidth-co[3][0])/(co[3][0]-co[2][0])-rightTop;
    t.canvas.setAttribute('width', totalWidth);
    t.canvas.setAttribute('height', height);
    if (co[2][0]<co[0][0]) {
      t.translate(co[0][0]-co[2][0], 0);
    }
    for (var i=0; i<height; i++) {
      t.drawImage(src, 0, i, width, 1, leftChange*i/height, i, Math.abs((topWidth*(height-i)+botWidth*i)/height), 1);
    }
    for (var i=0; i<totalWidth; i++) {
      this.drawImage(t.canvas, i, 0, 1, height, leftSpace+i, (leftTop*(totalWidth-i)+rightTop*i)/totalWidth, 1, (leftBot*(totalWidth-i)+rightBot*i)/totalWidth);
    }
    this.restore();
  }
  
  var playVideo = function() {
    var interval = 0,
        images = [],
        videoLoaded = false,
        step = true,
        image = document.getElementById("image"),
        emotion = twitterData,
        video = document.getElementById(emotion),
        middle = document.getElementById("middle"),
        canvasCtx = document.getElementById("canvas").getContext("2d"),
        imageCanvas = document.getElementById("canvas2").getContext("2d");

    var i = {
      i: 0,
      getIndex: function() {
        if (this.i < images.length) {
          return this.i++;
        } else {
          this.i = 1;
          return 0;
        }
      }
  
    };

    $.getJSON("http://api.flickr.com/services/feeds/photos_public.gne?tags=" + emotion + "&lang=en-us&format=json&jsoncallback=?", function(data){
      images = data.items;
      
      document.getElementById("canvas").style.display = "inline"; 
      
      window.setInterval((function() {
        if (step) {
          if (!videoLoaded) {
            videoLoaded = true;
            middle.pause();
            middle.currentTime = 0;
            video.play();

            image.src = images[i.getIndex()].media.m;
          }
          if (video.currentTime <= DURATION) {
            canvasCtx.drawImage(video, 0, 0, video.width, video.height);
          } else {
            step = false;
            document.getElementById("canvas2").style.display = "inline";
            imageCanvas.skew(image, [[129,5],[406,39],[96,157],[374,209]]);
          }
        } else {
          if (videoLoaded) {
            videoLoaded = false;
            video.pause();
            video.currentTime = 0;
            middle.play();
          }
          if (middle.currentTime <= DURATION) {
            canvasCtx.drawImage(middle, 0, 0, video.width, video.height);
          } else {
            step = true;
            document.getElementById("canvas2").style.display = "none";
          }
        }
      }), 10);
    });

  };
</script>
</head>

<div style="text-align:center;">
  <div id="page1">
    Location: <input id="location" type="text" value="toronto" name="location" /><input type ="checkbox" id="checkmark" > use current location<br />
    Twitter:  <input id="twitter" type="text" value="@StephenAtHome" name="twitter" /><br />
    <button type="button" onClick="run();">Click Me!</button><br />
  </div><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <div id="page2" style="position:relative;">
    <video src="http://scotland.proximity.on.ca/sdowne/lff/sad.ogg" style="display:none;" width="480" height="270" id="sad"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/happy.ogg" style="display:none;" width="480" height="270" id="happy"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/angry.ogg" style="display:none;" width="480" height="270" id="angry"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/neutral.ogg" style="display:none;" width="480" height="270" id="neutral"></video>
    <video src="http://scotland.proximity.on.ca/sdowne/lff/middle.ogg" style="display:none;" width="480" height="270" id="middle"></video>

    <img style="display:none;" id="image" />
    <canvas style="display:none;" id="canvas" width="480" height="270" ></canvas>
    <canvas style="display:none;position:absolute;left:0px" id="canvas2" width="480" height="270" ></canvas>
  </div>
</div></html>
